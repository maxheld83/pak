<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="pak">
<title>pak internals • pak</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="pak internals">
<meta property="og:description" content="pak">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="/pak.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">pak</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.7.2.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/get-started.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/faq.html">FAQ</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/internals.html">pak internals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/pak/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>pak internals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/pak/blob/HEAD/vignettes/internals.qmd" class="external-link"><code>vignettes/internals.qmd</code></a></small>
      <div class="d-none name"><code>internals.qmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-embedded-library">The embedded library<a class="anchor" aria-label="anchor" href="#the-embedded-library"></a>
</h2>
<p>From version 0.7.0, the pak source repo and the pak source package
includes all of the dependent packages in <code>src/library</code>. They
are installed during <code>R CMD INSTALL</code>. in the compilation
step. It is started from <code>Makevars</code> (generaged from
<code>Makevars.in</code>), and it is implemented via the
<code>src/install-embedded.R</code> script.</p>
<p><code>install-embedded.R</code> istalls all embedded dependencies in
the correct order, into <code>/library</code> in the package we are
building.</p>
<div class="section level3">
<h3 id="advantages">Advantages<a class="anchor" aria-label="anchor" href="#advantages"></a>
</h3>
<ul>
<li>Much simpler installation. No need to download anything. Hopefully
it works fine on CRAN.</li>
<li>It is now possible to write real tests for pak, that can also run on
CRAN, if we want.</li>
<li>A pak version always has the same dependencies. In the past the
versions of the embedded packages could be different.</li>
<li>Better development. No need to manually install dependencies before
calling <code>load_all()</code>.</li>
<li>We can install dev pak from GitHub or other sources now seemlessly,
using pak itself (in another library), or remotes, or from a local git
clone, etc.</li>
</ul>
</div>
<div class="section level3">
<h3 id="disadvantages">Disadvantages<a class="anchor" aria-label="anchor" href="#disadvantages"></a>
</h3>
<ul>
<li>Starting another installation during the installation is slightly
tricky. We need to unset a number of environment variables (see them in
<code>Makevars.in</code>). Hopefully this won’t be too fragile.</li>
<li>The source package is bigger. Still not very big.</li>
<li>pak always needs a compiler now when it is being installed from
source.</li>
</ul>
</div>
<div class="section level3">
<h3 id="updating-embedded-packages">Updating embedded packages<a class="anchor" aria-label="anchor" href="#updating-embedded-packages"></a>
</h3>
<p>The <code>embed.R</code> file has some tools for * listing the
versions of the embedded packages, * listing the versions available on
CRAN, * checking if we need to update a dependency, * updating a
dependency, etc.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgload</span><span class="fu">::</span><span class="fu"><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">embed</span><span class="op">$</span><span class="fu">check_update</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">embed</span><span class="op">$</span><span class="fu">update</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pkgloadload_all">
<code>pkgload::load_all()</code><a class="anchor" aria-label="anchor" href="#pkgloadload_all"></a>
</h3>
<p>We do not embed dependencies in this case, but we create a separate
library in the user cache directory. This happens from
<code>.onLoad()</code>. <code>.onLoad()</code> regcognizes
<code>load_all()</code> and calls <code>install-embedded.R</code> again,
with a special argument, to install dependencies into the user cache
library. We use hashing to decide if a dependency should be updated in
the private library, so updates work for dependencies on GitHub.</p>
</div>
<div class="section level3">
<h3 id="embedding-dev-packages-from-github">Embedding dev packages from GitHub<a class="anchor" aria-label="anchor" href="#embedding-dev-packages-from-github"></a>
</h3>
<p>Is now supported.</p>
</div>
<div class="section level3">
<h3 id="cross-compilation">Cross compilation<a class="anchor" aria-label="anchor" href="#cross-compilation"></a>
</h3>
<p>pak supports cross-compilation now. You need to pass
<code>--host=&lt;platform&gt;</code> to <code>./configure</code> via the
<code>--configure-args</code> argument of <code>R CMD INSTALL</code> to
do cross-compilation. You also need to set up the compilers, e.g. via
<code>~/.R/Makevars</code>.</p>
<p>Currently you need to install all of pak’s dependencies (ideally the
vendored ones) before cross-compiling. This is because the dependencies
have to be able to load their dependencies during cross compilation.
This is not great, and I am planning to improve it in the near future.
In particular, PPM cannot build pak binaries now for macOS because of
this, because the PPM build system only installs the declared
dependencies before cross compilation, but of course it does not know
about the embedded dependencies.</p>
<p><code>install-embedded.R</code> handles cross-compoilation specially.
(It has to.) It installs each dependency into its own library, and then
moves them into the common library at the end. This is so that they can
load their dependencies from the native library during their
installation.</p>
<p><code>install-embedded.R</code> updates the <code>Built</code> fields
in the metadata of the embedded packages, and also for the pak package
itself, after compilation.</p>
<p>Cross-compilation is currently used</p>
<ul>
<li>to build the macOS arm64 binaries on x86_64 macOS (see
<code>tools/build/macos</code>),</li>
<li>to build static aarch64 Linux binaries on x86_64 Linux (see
<code>tools/build/Linux/Dockerfile-aarch64</code> and other files
there),</li>
<li>on PPM, to cross compile (x86_64 and arm64) macOS binaries on x86_64
Linux. (This does not work currently.)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="our-repository-of-pak-builds">Our repository of pak builds<a class="anchor" aria-label="anchor" href="#our-repository-of-pak-builds"></a>
</h2>
<div class="section level3">
<h3 id="r-versions">R versions<a class="anchor" aria-label="anchor" href="#r-versions"></a>
</h3>
<p>We usually support at least one more R version than the tidyverse, so
the last six release and R-devel. This is to give people time to update
their GitHub actions.</p>
</div>
<div class="section level3">
<h3 id="platforms">Platforms<a class="anchor" aria-label="anchor" href="#platforms"></a>
</h3>
<p>Currently:</p>
<ul>
<li>Windows x86_64.</li>
<li>macOS x86_64.</li>
<li>macOS arm64 (cross compiled on x86_64 macOS).</li>
<li>Linux x86_64 static.</li>
<li>Linux aarch64 static (cross compiled on x86_64 Linux).</li>
</ul>
<p>Hopefully soon:</p>
<ul>
<li>Windows arm64. (The challenge is that we either need to
cross-compile or have a self-hosted runner to build packages.)</li>
</ul>
</div>
<div class="section level3">
<h3 id="streams">Streams<a class="anchor" aria-label="anchor" href="#streams"></a>
</h3>
<div class="section level4">
<h4 id="stable">Stable<a class="anchor" aria-label="anchor" href="#stable"></a>
</h4>
<p>Latest CRAN release, with a version number with three components.</p>
</div>
<div class="section level4">
<h4 id="rc">RC<a class="anchor" aria-label="anchor" href="#rc"></a>
</h4>
<p>Release condidate, typically shortly before a release, with a version
number with four or more components, the fourth one is
<code>9999</code>.</p>
<p>At other times it is the same as the stable stream.</p>
</div>
<div class="section level4">
<h4 id="devel">Devel<a class="anchor" aria-label="anchor" href="#devel"></a>
</h4>
<p>Build daily from the <code>main</code> branch of <a href="https://github.com/r-lib/pak" class="external-link uri">https://github.com/r-lib/pak</a>. It has a version number
with four or more components, the fourth one is <code>9000</code> or
larger, but it is not <code>9999</code> (as that would be an RC
version).</p>
</div>
</div>
<div class="section level3">
<h3 id="update-procedure">Update procedure<a class="anchor" aria-label="anchor" href="#update-procedure"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Package binaries are built on GitHub Actions, in the
<code>nightly.yaml</code> workflow.</li>
<li>They are pushed to GitHub Packages, to the <code>pak</code> package,
in the <code>r-lib/pak</code> repo: <a href="https://github.com/r-lib/pak/pkgs/container/pak" class="external-link uri">https://github.com/r-lib/pak/pkgs/container/pak</a>.</li>
<li>For each successful push, the manifest file on the
<code>packages</code> branch is updated: <a href="https://github.com/r-lib/pak/tree/packages" class="external-link uri">https://github.com/r-lib/pak/tree/packages</a>.</li>
<li>They are deployed to GitHub Packages, to this repo: <a href="https://github.com/r-lib/r-lib.github.io" class="external-link uri">https://github.com/r-lib/r-lib.github.io</a>.</li>
</ol>
</div>
<div class="section level3">
<h3 id="the-nightly-yaml-workflow">The <code>nightly.yaml</code> workflow<a class="anchor" aria-label="anchor" href="#the-nightly-yaml-workflow"></a>
</h3>
<p>Can be also run manually, on a subset of all platforms, if needed.
Othewise it runs daily: <a href="https://github.com/r-lib/pak/actions/workflows/nightly.yaml" class="external-link uri">https://github.com/r-lib/pak/actions/workflows/nightly.yaml</a>.</p>
</div>
<div class="section level3">
<h3 id="github-packages">GitHub Packages<a class="anchor" aria-label="anchor" href="#github-packages"></a>
</h3>
<p>All builds (via <code>Makefile</code>) upload the built packages to
GitHub Packages: <a href="https://github.com/r-lib/pak/pkgs/container/pak" class="external-link uri">https://github.com/r-lib/pak/pkgs/container/pak</a>. They
also update <code>manifest.json</code> at <a href="https://github.com/r-lib/pak/tree/packages" class="external-link uri">https://github.com/r-lib/pak/tree/packages</a>.
<code>manifest.json</code> is the ground truth for the repository.</p>
</div>
<div class="section level3">
<h3 id="github-pages">GitHub Pages<a class="anchor" aria-label="anchor" href="#github-pages"></a>
</h3>
<p>The challenge is that the site is very close to the 1GB limit,
sometimes it is slightly over, which still works, but we won’t be able
to add new platforms to it.</p>
<p>An alternative would be to keep the package in a repository, and use
<a href="https://raw.githubusercontent.com" class="external-link uri">https://raw.githubusercontent.com</a>. We would need to
create a <code>repo</code> branch, and have <a href="https://raw.githubusercontent.com/r-lib/pak/repo" class="external-link uri">https://raw.githubusercontent.com/r-lib/pak/repo</a> as the
repo URL. So the Windows and macOS binaries would go into</p>
<pre><code>https://raw.githubusercontent.com/r-lib/pak/repo/bin/windows/...
https://raw.githubusercontent.com/r-lib/pak/repo/bin/macosx/...</code></pre>
<p>etc.</p>
</div>
<div class="section level3">
<h3 id="challenges">Challenges<a class="anchor" aria-label="anchor" href="#challenges"></a>
</h3>
<div class="section level4">
<h4 id="concurrency">Concurrency<a class="anchor" aria-label="anchor" href="#concurrency"></a>
</h4>
<p>Dealing with concurrency on GHA is a challenge. GitHub Packages
requires that we push all architectures (=pak builds) at the same time.
(The package files do not need to be present of the client if they stay
the same.) So we treat <code>manifest.json</code> as the ground truth,
and we update it for the pak build(s) that we are about to push.</p>
<p>After pushing to GitHub Packages, we update
<code>manifest.json</code> and push that to GitHub. If the push is not
clean, then we need to do the whole update process again. With many
concurrent builds finishing around the same time, this happens a lot, so
in the end we do a lot of pushes to GitHub Packages.</p>
<p>An alternative would be to store each pak build in its own package at
GitHub Packages, instead of one multi-arch package. But it is also nice
to have a single package, instead of about a hundred one. (One for each
platform for each R version, for each stream.)</p>
</div>
<div class="section level4">
<h4 id="cleanup">Cleanup<a class="anchor" aria-label="anchor" href="#cleanup"></a>
</h4>
<p>Old packages are not cleaned up on GitHub Packages, so ideally we
would need to clean them up regularly, to avoid using too much space.
E.g. we could clean up packages that are older than (say) a week, and
that are not referenced from the <code>manifest.json</code> file. But we
don’t do that currently.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a>, <a href="https://jimhester.com" class="external-link">Jim Hester</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>, Ascent Digital Services, R Consortium.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

  </div></footer>
</body>
</html>
